/* =========================
   Rádio 24h
   Player persistente + SPA + Equalizador AO VIVO + Clock
========================= */

/* ===== Relógio ===== */
const clockEl = document.getElementById("clock");
function startClock() {
  updateClock();
  setInterval(updateClock, 1000);
}
function updateClock() {
  const now = new Date();
  clockEl.textContent = now.toLocaleTimeString();
}

/* ===== DOM refs ===== */
const player = document.getElementById("player");
let trackName = document.getElementById("trackName");
const playBtn = document.getElementById("playBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const appMain = document.getElementById("app-main");

/* ===== Equalizador AO VIVO ===== */
const liveBars = () => document.querySelectorAll(".live-bars span");
function animateLiveBars() {
  const bars = liveBars();
  if (!bars || bars.length === 0) return;
  const base = player && !player.paused ? 6 : 3;
  bars.forEach((b) => {
    const variance = Math.random() * 16;
    const height = Math.round(base + variance);
    b.style.height = height + "px";
  });
}
setInterval(animateLiveBars, 250);

/* ===== Playlist do GitHub ===== */
const apiUrl = "https://api.github.com/repos/claviiisorg/radio-musicas/releases/tags/musicas";
let playlist = [];
let current = -1;

async function loadPlaylistFromGithub() {
  try {
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error("Erro HTTP " + res.status);
    const data = await res.json();
    if (!data.assets || !data.assets.length) {
      trackName && (trackName.textContent = "Nenhuma música disponível.");
      return;
    }

    playlist = data.assets.map((a) => ({
      url: a.browser_download_url,
      name: a.name.replace(/\.[^/.]+$/, "").replace(/_/g, " "),
    }));

    const savedIndex = Number(localStorage.getItem("currentSong"));
    const savedTime = Number(localStorage.getItem("currentTime")) || 0;

    if (!Number.isNaN(savedIndex) && savedIndex >= 0 && savedIndex < playlist.length) {
      current = savedIndex;
      loadSong(current, savedTime);
    } else {
      playRandom();
    }
  } catch (err) {
    console.error("Erro ao carregar playlist do GitHub:", err);
    trackName && (trackName.textContent = "Erro ao carregar músicas.");
  }
}

/* ===== Carregar e tocar música ===== */
function loadSong(index, startTime = 0) {
  if (!playlist.length || index < 0 || index >= playlist.length) return;
  current = index;
  const song = playlist[index];
  player.src = song.url;
  player.currentTime = startTime;
  trackName && (trackName.textContent = song.name);
  const p = player.play();
  if (p && p.catch) p.catch(() => {});
  localStorage.setItem("currentSong", current);
}

/* ===== Aleatório ===== */
function playRandom() {
  if (!playlist.length) return;
  let next;
  do {
    next = Math.floor(Math.random() * playlist.length);
  } while (next === current && playlist.length > 1);
  loadSong(next);
}

/* ===== Eventos ===== */
player.addEventListener("ended", playRandom);

/* Salva posição atual a cada 1s */
setInterval(() => {
  if (!isNaN(player.currentTime)) localStorage.setItem("currentTime", player.currentTime);
}, 1000);

/* ===== Botões ===== */
if (playBtn) playBtn.addEventListener("click", () => {
  player.play().catch(()=>{});
});
if (prevBtn) prevBtn.addEventListener("click", () => playRandom());
if (nextBtn) nextBtn.addEventListener("click", () => playRandom());

/* ===== SPA navigation ===== */
async function loadPage(url, pushHistory = true) {
  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Falha ao carregar página: " + res.status);
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, "text/html");

    const remoteMain = doc.querySelector("main");
    const newMainHtml = remoteMain ? remoteMain.innerHTML : doc.body.innerHTML;

    appMain.innerHTML = newMainHtml;
    document.title = doc.title || document.title;
    fixImages(appMain);
    updateActiveNav(url);
    ensureClockAndLive();
    ensurePlayer();

    if (pushHistory) history.pushState({ url }, "", url);
  } catch (err) {
    console.error("Erro ao carregar página via SPA:", err);
  }
}

function updateActiveNav(url) {
  document.querySelectorAll('nav a[data-nav]').forEach((a) => {
    const aUrl = new URL(a.href, location.origin).pathname;
    const u = new URL(url, location.origin).pathname;
    a.classList.toggle("active", aUrl === u);
  });
}

document.addEventListener("click", (ev) => {
  const a = ev.target.closest && ev.target.closest("a[data-nav]");
  if (!a) return;
  const href = a.getAttribute("href");
  if (!href) return;
  ev.preventDefault();
  loadPage(href, true);
});

window.addEventListener("popstate", (ev) => {
  const url = (ev.state && ev.state.url) || location.pathname;
  loadPage(url, false);
});

/* ===== Helper ===== */
function fixImages(container) {
  container.querySelectorAll("img").forEach((img) => {
    img.onerror = function () {
      this.onerror = null;
      this.src = "https://via.placeholder.com/600x350?text=Imagem+n%C3%A3o+dispon%C3%ADvel";
    };
    if (!img.alt) img.alt = "Imagem";
  });
}

function ensureClockAndLive() {
  if (!clockEl.textContent) startClock();
}

function ensurePlayer() {
  if (!player.paused) return;
  if (playlist.length && current >= 0) {
    const currentTime = Number(localStorage.getItem("currentTime")) || 0;
    loadSong(current, currentTime);
  }
}

/* ===== Autoplay ao primeiro clique (necessário no navegador) ===== */
document.addEventListener("click", () => {
  if (player.paused && playlist.length && current >= 0) {
    const currentTime = Number(localStorage.getItem("currentTime")) || 0;
    loadSong(current, currentTime);
    player.muted = false; // desativa mute após clique
  }
}, { once: true });

/* ===== Inicialização ===== */
function init() {
  startClock();
  fixImages(document);
  loadPlaylistFromGithub();

  const path = location.pathname.replace(/^\//, "");
  if (path && path !== "" && path !== "index.html") {
    loadPage(location.pathname, false);
  }

  updateActiveNav(location.pathname);
}

init();
